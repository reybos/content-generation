# Итоговая документация по реализации нового формата JSON

## Что было реализовано

### 1. Новые типы данных
- Добавлены типы `Prompt`, `NewFormatData` и `ContentData` в `src/types/generation.ts`
- Создан union тип для поддержки обоих форматов

### 2. Новые сервисы
- **NewFormatWorker** (`src/services/new-format-worker.ts`) - специализированный воркер для нового формата
- **UniversalWorker** (`src/services/universal-worker.ts`) - универсальный воркер, автоматически определяющий формат

### 3. Обновленные сервисы
- **FileService** - обновлен для поддержки нового формата
- **PreprocessWorker** - добавлена поддержка блокировки и улучшена обработка ошибок

### 4. Обновленный основной воркер
- **ContentGenerationWorker** - теперь использует UniversalWorker вместо PreprocessWorker

## Логика работы

### Определение формата
Система автоматически определяет формат файла:

**Новый формат** (с полями `global_style`, `prompts`, `title`, `description`, `hashtags`):
```json
{
  "global_style": "Общий стиль",
  "prompts": [
    {
      "line": "Текст",
      "prompt": "Промпт для изображения"
    }
  ],
  "title": "Заголовок",
  "description": "Описание",
  "hashtags": "Хештеги"
}
```

**Старый формат** (с полями `script`, `character`, `enhancedMedia`):
```json
{
  "script": { ... },
  "character": { ... },
  "enhancedMedia": [ ... ]
}
```

### Процесс обработки нового формата

1. **Чтение файла** - JSON файл читается из папки `unprocessed`
2. **Определение формата** - система проверяет структуру данных
3. **Создание папки** - создается папка в `in-progress`
4. **Блокировка** - файл блокируется для предотвращения конфликтов
5. **Перемещение** - JSON файл перемещается в папку обработки
6. **Генерация изображений** - для каждого элемента из `prompts`:
   - Промпт объединяется с `global_style`
   - Генерируется изображение с названием `scene_0.png`, `scene_1.png` и т.д.
   - Все изображения генерируются параллельно
7. **Завершение** - папка перемещается в `processed`

## Структура файлов

```
processed/
└── example-folder/
    ├── example-folder.json    # Исходный JSON файл
    ├── scene_0.png           # Изображение для первого промпта
    ├── scene_1.png           # Изображение для второго промпта
    ├── scene_2.png           # Изображение для третьего промпта
    └── ...
```

## Тестирование

Создан тестовый скрипт `test-new-format.js` для проверки функциональности:

```bash
npm run build
node test-new-format.js
```

Тест создает:
- Тестовую структуру папок
- Копирует тестовый JSON файл в `unprocessed`
- Запускает обработку в режиме mock
- Проверяет результат в `processed`

## Совместимость

Система полностью совместима с существующим форматом:
- Автоматическое определение формата
- Обратная совместимость
- Единый интерфейс обработки

## Безопасность

- **Блокировка файлов** - предотвращает конфликты между потоками
- **Обработка ошибок** - неудачные обработки перемещаются в `failed`
- **Валидация данных** - проверка структуры JSON перед обработкой

## Производительность

- **Параллельная генерация** - все изображения генерируются одновременно
- **Эффективное использование ресурсов** - блокировки предотвращают дублирование работы
- **Масштабируемость** - система поддерживает множественные воркеры

## Заключение

Реализация успешно добавляет поддержку нового формата JSON с сохранением полной совместимости с существующим форматом. Система автоматически определяет формат и использует соответствующий обработчик, обеспечивая надежную и масштабируемую обработку контента. 